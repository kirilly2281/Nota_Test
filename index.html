  <!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>UX/UI Training Platform</title>
    </head>

    <body>

      <div id="root"></div>
     <script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://txmvkbixfzlsumvmzoyn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4bXZrYml4Znpsc3Vtdm16b3luIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMTA4ODMsImV4cCI6MjA4MjU4Njg4M30.hFW0Ndbs7STWlA294xe3lQqJ4Lj2mxFGGuQP-ncbnDY";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const root = document.getElementById("root");
  root.innerHTML = "<p style='padding:20px'>Loading...</p>";

  async function login(email) {
    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: {
        // Жёстко укажите ваш Pages URL, чтобы не улетать на корень домена
        emailRedirectTo: "https://kirilly2281.github.io/Nota_Test/"
      }
    });

    if (error) alert(error.message);
    else alert("Проверь почту — отправил ссылку для входа.");
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function escapeAttr(str) {
    return escapeHtml(str);
  }

  async function renderAdmin() {
    const { data: allSubs, error } = await supabase
      .from("submissions")
      .select("id, task_id, user_id, result_url, student_comment, status, score, admin_comment, created_at")
      .order("created_at", { ascending: false });

    if (error) {
      root.innerHTML = `<pre style="white-space:pre-wrap">Admin load error:\n${error.message}</pre>`;
      return;
    }

    root.innerHTML = `
      <div style="max-width:1000px;margin:50px auto;font-family:system-ui">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0">Admin review</h2>
            <div style="opacity:.8;margin-top:6px">Total submissions: ${(allSubs || []).length}</div>
          </div>
          <button id="logout">Logout</button>
        </div>

        <div style="margin-top:18px">
          ${(allSubs || []).map(s => `
            <div style="border:1px solid #ddd;padding:14px;border-radius:12px;margin:12px 0">
              <div style="font-weight:700">#${s.id} — ${s.status}</div>
              <div style="opacity:.8;margin:6px 0">task_id: ${s.task_id} · user_id: ${s.user_id}</div>
              ${s.result_url ? `<div><a href="${s.result_url}" target="_blank">Result link</a></div>` : ""}
              ${s.student_comment ? `<div style="margin-top:6px">Student: ${escapeHtml(s.student_comment)}</div>` : ""}

              <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <input class="score" data-id="${s.id}" placeholder="Score (0-100)" value="${s.score ?? ""}" style="width:140px;padding:8px"/>
                <input class="acomment" data-id="${s.id}" placeholder="Admin comment" value="${escapeAttr(s.admin_comment ?? "")}" style="min-width:280px;flex:1;padding:8px"/>
                <button class="mark-reviewed" data-id="${s.id}">Mark reviewed</button>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    `;

    document.getElementById("logout").onclick = async () => {
      await supabase.auth.signOut();
      location.reload();
    };

    document.querySelectorAll(".mark-reviewed").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = Number(btn.getAttribute("data-id"));
        const score = document.querySelector(`.score[data-id="${id}"]`).value.trim();
        const adminComment = document.querySelector(`.acomment[data-id="${id}"]`).value.trim();

        const payload = {
          status: "reviewed",
          score: score ? Number(score) : null,
          admin_comment: adminComment || null
        };

        const { error } = await supabase
          .from("submissions")
          .update(payload)
          .eq("id", id);

        if (error) alert("Ошибка обновления: " + error.message);
        else {
          alert("Проверено");
          location.reload();
        }
      });
    });
  }

  async function renderStudent() {
    const { data: subs, error: subsError } = await supabase
      .from("submissions")
      .select("id, task_id, result_url, student_comment, status, score, admin_comment, created_at")
      .eq("user_id", user.id);

    if (subsError) {
      root.innerHTML = `<pre style="white-space:pre-wrap">Submissions load error:\n${subsError.message}</pre>`;
      return;
    }

    const { data: tasks, error: tasksError } = await supabase
      .from("tasks")
      .select("id, title, description, materials_url, sort_order")
      .order("sort_order", { ascending: true });

    if (tasksError) {
      root.innerHTML = `<pre style="white-space:pre-wrap">Tasks load error:\n${tasksError.message}</pre>`;
      return;
    }

    const subByTaskId = new Map((subs || []).map(s => [s.task_id, s]));

    const totalTasks = (tasks || []).length;
    const reviewedTaskIds = new Set((subs || []).filter(s => s.status === "reviewed").map(s => s.task_id));
    const reviewedCount = [...reviewedTaskIds].filter(id => (tasks || []).some(t => t.id === id)).length;
    const progressPct = totalTasks === 0 ? 0 : Math.round((reviewedCount / totalTasks) * 100);

    root.innerHTML = `
      <div style="max-width:900px;margin:50px auto;font-family:system-ui">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:20px">
          <div>
            <h2 style="margin:0">Tasks</h2>
            <div style="margin-top:8px;opacity:.85">
              Reviewed: <b>${reviewedCount}</b> / <b>${totalTasks}</b> (${progressPct}%)
            </div>
            <div style="margin-top:8px;width:340px;max-width:60vw;background:#eee;border-radius:999px;height:10px;overflow:hidden">
              <div style="height:10px;width:${progressPct}%;background:#111"></div>
            </div>
          </div>
          <button id="logout">Logout</button>
        </div>

        <div style="margin-top:18px">
          ${(tasks || []).map(t => {
            const s = subByTaskId.get(t.id);

            const statusPill = !s
              ? `<span style="display:inline-block;padding:2px 8px;border:1px solid #bbb;border-radius:999px;font-size:12px;opacity:.8">Not submitted</span>`
              : (s.status === "reviewed"
                  ? `<span style="display:inline-block;padding:2px 8px;border:1px solid #111;border-radius:999px;font-size:12px">Reviewed</span>`
                  : `<span style="display:inline-block;padding:2px 8px;border:1px solid #bbb;border-radius:999px;font-size:12px">Submitted</span>`);

            const resultLink = s?.result_url
              ? `<div><a href="${escapeAttr(s.result_url)}" target="_blank">Your result link</a></div>`
              : "";
            const commentLine = s?.student_comment
              ? `<div style="opacity:.85;margin-top:6px">Comment: ${escapeHtml(s.student_comment)}</div>`
              : "";
            const adminCommentLine = s?.admin_comment
              ? `<div style="opacity:.85;margin-top:6px">Admin comment: ${escapeHtml(s.admin_comment)}</div>`
              : "";
            const scoreLine = s?.score !== null && s?.score !== undefined
              ? `<div style="opacity:.85;margin-top:6px">Score: ${s.score}</div>`
              : "";

            const actionBlock = !s
              ? `<div style="margin-top:10px;padding:10px;border:1px dashed #bbb;border-radius:10px">
                   <div style="display:flex;flex-direction:column;gap:8px">
                     <input class="submit-url" data-task="${t.id}" type="url" placeholder="Result link" required style="padding:8px"/>
                     <textarea class="submit-comment" data-task="${t.id}" placeholder="Comment (optional)" style="padding:8px;min-height:80px"></textarea>
                     <button class="submit-btn" data-task="${t.id}">Submit</button>
                   </div>
                 </div>`
              : `<div style="margin-top:10px;padding:10px;border:1px dashed #bbb;border-radius:10px">
                   ${resultLink}
                   ${commentLine}
                   ${s.status === "reviewed"
                      ? `<div style="margin-top:8px;opacity:.85">Checked by admin</div>
                         ${adminCommentLine}
                         ${scoreLine}`
                      : `<div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
                           <input class="edit-url" data-sub="${s.id}" type="url" placeholder="Result link" value="${escapeAttr(s.result_url ?? "")}" required style="padding:8px"/>
                           <textarea class="edit-comment" data-sub="${s.id}" placeholder="Comment (optional)" style="padding:8px;min-height:80px">${escapeHtml(s.student_comment ?? "")}</textarea>
                           <button class="save-btn" data-sub="${s.id}">Save</button>
                         </div>`
                    }
                 </div>`;

            return `
              <div style="border:1px solid #ddd;padding:14px;border-radius:12px;margin:12px 0">
                <div style="margin-bottom:8px">${statusPill}</div>
                <div style="font-weight:700">${t.title}</div>
                <div style="opacity:.85;margin:6px 0">${t.description ?? ""}</div>
                ${t.materials_url ? `<a href="${t.materials_url}" target="_blank">Materials</a>` : ""}
                ${actionBlock}
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `;

    document.getElementById("logout").onclick = async () => {
      await supabase.auth.signOut();
      location.reload();
    };

    // submit
    document.querySelectorAll(".submit-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const originalLabel = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Submitting...";
        const taskId = Number(btn.getAttribute("data-task"));
        const resultInput = document.querySelector(`.submit-url[data-task="${taskId}"]`);
        const commentInput = document.querySelector(`.submit-comment[data-task="${taskId}"]`);
        const resultUrl = resultInput?.value.trim() || "";
        const comment = commentInput?.value.trim() || "";
        if (!resultUrl) {
          alert("Добавьте ссылку на результат.");
          btn.disabled = false;
          btn.textContent = originalLabel;
          return;
        }

        const { error } = await supabase.from("submissions").insert({
          task_id: taskId,
          user_id: user.id,
          result_url: resultUrl,
          student_comment: comment,
          status: "submitted"
        });

        if (error) {
          if (error.code === "23505" || /unique|duplicate/i.test(error.message)) {
            alert("You already submitted this task. Please use Save to update your submission.");
          } else {
            alert("Ошибка отправки: " + error.message);
          }
          btn.disabled = false;
          btn.textContent = originalLabel;
        } else {
          location.reload();
        }
      });
    });

    // edit (только для submitted; для reviewed мы выше убрали кнопку)
    document.querySelectorAll(".save-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const originalLabel = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Saving...";
        const subId = Number(btn.getAttribute("data-sub"));
        const resultInput = document.querySelector(`.edit-url[data-sub="${subId}"]`);
        const commentInput = document.querySelector(`.edit-comment[data-sub="${subId}"]`);
        const newUrl = resultInput?.value.trim() || "";
        const newComment = commentInput?.value.trim() || "";
        if (!newUrl) {
          alert("Добавьте ссылку на результат.");
          btn.disabled = false;
          btn.textContent = originalLabel;
          return;
        }

        const { error } = await supabase
          .from("submissions")
          .update({ result_url: newUrl, student_comment: newComment })
          .eq("id", subId);

        if (error) {
          alert("Ошибка обновления: " + error.message);
          btn.disabled = false;
          btn.textContent = originalLabel;
        } else {
          location.reload();
        }
      });
    });
  }

  // 1) Проверяем пользователя
  const { data: userResp } = await supabase.auth.getUser();
  const user = userResp?.user || null;

  // 2) Если не залогинен — показываем форму
  if (!user) {
    root.innerHTML = `
      <div style="max-width:420px;margin:60px auto;font-family:system-ui">
        <h2>Login</h2>
        <input id="email" placeholder="you@company.com" style="width:100%;padding:10px;margin:10px 0"/>
        <button id="login" style="padding:10px 14px">Send magic link</button>
      </div>
    `;

    document.getElementById("login").onclick = async () => {
      const email = document.getElementById("email").value.trim();
      if (!email) return alert("Введите email");

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: "https://kirilly2281.github.io/Nota_Test/" }
      });

      if (error) alert(error.message);
      else alert("Проверь почту — отправил ссылку для входа.");
    };
  } else {
    // гарантируем, что профиль есть
    await supabase.from("profiles").upsert(
      { id: user.id, name: user.email },
      { onConflict: "id" }
    );

    // читаем роль
    const { data: profile, error: profileError } = await supabase
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .single();

    if (profileError) {
      root.innerHTML = `<pre style="white-space:pre-wrap">Profile load error:\n${profileError.message}</pre>`;
      throw profileError;
    }

    const role = profile.role;

    if (role === "admin") {
      await renderAdmin();
    } else {
      await renderStudent();
    }
  }
</script>
    </body>
  </html>
